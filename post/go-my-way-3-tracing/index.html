<!DOCTYPE html>
<html lang="ko-kr">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<meta http-equiv="X-UA-Compatible" content="IE=edge">
	<title>Go My Way #3 - 트레이싱</title>
	<meta name="description" content="">
	<meta name="generator" content="Hugo 0.37.1" />
	<meta property="og:title" content="Go My Way #3 - 트레이싱" />
<meta property="og:description" content="Go My Way는 Go 언어로 웹 어플리케이션을 작성할 때 선호하는 나만의 방식을 3편에 걸쳐서 소개하는 글이다. 이전 글은 읽지 않았다면 아래 링크를 참조하기 바란다.
 Go My Way #1 - 웹 프레임워크 Go My Way #2 - 데이터베이스, 로깅 Go My Way #3 - 트레이싱 번외 - gomobile  이번 글에서는 트레이싱에 대해 소개하겠다.
이 글을 작성하는 지금 현재 우리 회사는 클라우드 상에 50여 개의 마이크로 서비스가 서로 얽혀서 동작하고 있다." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://jaehue.github.io/post/go-my-way-3-tracing/" />



<meta property="article:published_time" content="2017-10-30T00:00:00&#43;08:00"/>

<meta property="article:modified_time" content="2017-10-30T00:00:00&#43;08:00"/>











	
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">
	<link rel="stylesheet" href="/css/style.css">
	<script type="text/javascript" src="/js/scripts.js"></script>
	<link rel="shortcut icon" href="/favicon.ico">
	
<script>
window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
ga('create', 'UA-91404316-1', 'auto');
ga('send', 'pageview');
</script>
<script async src='//www.google-analytics.com/analytics.js'></script>

</head>
<body class="body body-right-sidebar">
	<div class="container container-outer">
		<header class="header">
			<div class="container container-inner">
				<div class="logo" role="banner">
					<a class="logo__link" href="/" title="Jaehue&#39;s" rel="home">
						<div class="logo__title">Jaehue&#39;s</div>
						<div class="logo__tagline">생각들</div>
					</a>
				</div>
			</div>
			<div class="divider"></div>
		</header>
		<div class="wrapper clearfix">

<main class="main content">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">Go My Way #3 - 트레이싱</h1><div class="post__meta meta">
<svg class="icon icon-time" width="16" height="14" viewBox="0 0 16 16"><path d="m8-.0000003c-4.4 0-8 3.6-8 8 0 4.4000003 3.6 8.0000003 8 8.0000003 4.4 0 8-3.6 8-8.0000003 0-4.4-3.6-8-8-8zm0 14.4000003c-3.52 0-6.4-2.88-6.4-6.4000003 0-3.52 2.88-6.4 6.4-6.4 3.52 0 6.4 2.88 6.4 6.4 0 3.5200003-2.88 6.4000003-6.4 6.4000003zm.4-10.4000003h-1.2v4.8l4.16 2.5600003.64-1.04-3.6-2.1600003z"/></svg>
<time class="post__meta-date meta-date" datetime="2017-10-30T00:00:00">October 30, 2017</time>
<span class="post__meta-categories meta-categories">
	<svg class="icon icon-category" width="16" height="16" viewBox="0 0 16 16"><path d="m7 2l1 2h8v11h-16v-13z"/></svg>
	<span class="meta-categories__list"><a class="meta-categories__link" href="/categories/it" rel="category">IT</a></span>
</span></div>
		</header>
		<div class="post__content clearfix">
			

<p><strong>Go My Way</strong>는 Go 언어로 웹 어플리케이션을 작성할 때 선호하는 나만의 방식을 3편에 걸쳐서 소개하는 글이다.
이전 글은 읽지 않았다면 아래 링크를 참조하기 바란다.</p>

<ul>
<li><a href="/post/go-my-way-1-webframework/">Go My Way #1 - 웹 프레임워크</a></li>
<li><a href="/post/go-my-way-2-database-and-logging/">Go My Way #2 - 데이터베이스, 로깅</a></li>
<li>Go My Way #3 - 트레이싱</li>
<li>번외 - gomobile</li>
</ul>

<p>이번 글에서는 <code>트레이싱</code>에 대해 소개하겠다.</p>

<p>이 글을 작성하는 지금 현재 우리 회사는 클라우드 상에 50여 개의 마이크로 서비스가 서로 얽혀서 동작하고 있다.
사용자의 한 번의 클릭이 실제로는 여러 마이크로 서비스들을 거치고 거쳐서 최종 결과를 고객에게 보여준다.
처리 과정 중에 비즈니스적으로 주요 행위가 일어나면 이벤트가 발생하고, consumer service가 그 이벤트를 받아서 여러 액션을 처리한다.</p>

<p><img src="/images/tracing/microservice.png" alt="microservice" /></p>

<blockquote>
<p><small>EventBroker: 이벤트를 publish하고 subscription 하는 일련의 과정을 처리해주는 서비스. 내부적으로는 kafka를 사용해서 이벤트를 전달한다.  기본적인 이벤트 전달 기능 외에 consume service간 balance 조정, 로깅, offset 관리 등의 일을 처리한다.</small></p>
</blockquote>

<p>마이크로 서비스 환경으로 1년 정도 운영을 해보니 기존의 모노리틱(monolitic) 방식과는 또 다른 어려움이 있었다.</p>

<h2 id="무엇이-문제인가">무엇이 문제인가?</h2>

<h3 id="오류를-추적하기가-어렵다">오류를 추적하기가 어렵다</h3>

<p>이제 더이상 nginx의 access log와 개발자가 개별적으로 남기는 로그만으로는 문제를 추적하기가 너무 어려워졌다.</p>

<ul>
<li>위와 같이 복잡한 처리 흐름이 이어지는 경우, A 서비스에서는 아무 문제가 없이 처리 되었는데 C 서비스는 아예 동작조차 하지 않았다.
프로그램상의 오류일까? 아니면 네트워크 장애인가? 어디에선가 타임아웃이 발생한 것은 아닐까?</li>
<li>이벤트를 받아 처리해야 하는 D 서비스가 동작하지 않았다면, 도대체 어디에서 문제가 발생한 것일까? 내 서비스는 문제 없는데(<em>당연하지! 내가 짰으니!!</em>) Event Broker가 이벤트를 먹어버린 걸까?</li>
</ul>

<p>다른 팀을 의심하기도 하고, 그냥 문제 해결을 포기하고 만다.
사용자는 불편을 겪고 있는데, 문제가 무엇인지 정의할 수도 없다.</p>

<h3 id="비즈니스-흐름을-파악하기-어렵다">비즈니스 흐름을 파악하기 어렵다</h3>

<p>하나의 마이크로 서비스가 만들어지면, 어느 팀이든지 그 서비스를 사용할 수 있다.
중요한 행위에 대해 이벤트를 정의하고 그 이벤트를 발생시키면, 필요한 누군가가 그 이벤트를 <em>subscribe</em> 해서 또 다른 로직을 이어간다.
이렇게 여러 팀이 개발한 서비스들이 서로 얽히고 얽혀서 하나의 요청이 처리된다.
이렇게 되다 보니 사용자가 버튼 하나를 클릭했을 때 어떤 일이 일어나는지 파악하는 것은 거의 불가능해졌다.
한 서비스의 작은 변경사항이 전혀 예상하지 못했던 곳에서 문제를 일으키기도 한다.</p>

<p>예전에는 비즈니스 로직을 파악하려면 소스코드를 한 줄 한 줄 읽어내려가면 되었지만,
지금과 같이 여러 서비스들 간의 상호작용으로 하나의 기능이 완성되는 마이크로 서비스 환경에서는
서비스들의 연관 관계가 명확하지 않으면 비즈니스 로직도 명확해질 수 없다.</p>

<p>음.. 우리가 고객에게 제공하는 기능이 정확히 어떻게 동작하는지도 모르는 상황이 되어 버렸다.</p>

<h3 id="병목-지점을-찾을-수-없다">병목 지점을 찾을 수 없다</h3>

<p>사용자 수가 갑자기 늘어난 것도 아니고 서버의 자원이 고갈된 것도 아닌데, 응답시간이 유난히 늦어질 때가 있다.
도대체 어디가 병목인 걸까?</p>

<h2 id="트레이스-시스템의-필요">트레이스 시스템의 필요</h2>

<p>이제 서비스의 모든 행위에 대한 기록을 남기고 이것을 투명하게 드러내야 할 필요성이 생겼다.</p>

<p>대표적인 트레이스 솔루션으로는 <a href="http://zipkin.io/">zipkin</a>, <a href="http://lightstep.com/">lightstep</a>, <a href="https://github.com/sourcegraph/appdash">appdash</a> 등이 있고, <a href="http://opentracing.io/">opentracing</a>를 사용하면 트레이스 서버로 모든 행위에 대한 정보를 쉽게 전달할 수 있다.
이런 잘 갖춰진(?) 솔루션들은 지금 당장 설치해서 사용하기는 쉽지만, 실제 운영을 해보면 여러 어려움에 부딪힌다.
그 어려움은 대부분 이 두 가지 패턴으로 좁혀지는데,</p>

<ul>
<li>기능이 너무 많다.<br />
그래서 학습해야 할 것도 많다.
사실 우리가 필요한 기능은 그 솔루션에서 제공하는 기능의 일부분일 뿐이다.
화려한 UI와 깔끔한 Getting Started 문서에 혹해서 시작은 했지만, 정작 내가 원하는 모습에 도달하기까지 학습해야 할 것이 한둘이 아니다.
특정 솔루션의 사용법을 학습하고 있자니, 주객이 전도되는 느낌을 받을 때가 있다.</li>
<li>정작 필요한 기능은 없다.<br />
여러 기능을 제공하고 있지만, 그 기능은 우리에게 딱 맞는 기능이 아니다.
결국, 우리 입맛에 맞게 customizing해서 사용해야 하는데, 그 과정에도 상당한 시간과 노력이 들어간다.</li>
</ul>

<p>어떤 솔루션을 처음 도입할 때는 그 솔루션의 문제 해결 방식과 사상을 잘 모르고 접근하는 경우가 많다.
어떤 솔루션이든 어떤 문제를 효율적으로 해결하기 위해 많은 시도를 하다가 최종적으로 최적화된 무언가가 만들어진 것일 텐데,
과정은 모른 채 최종 모습만 보고 따라 한다면 그것이 제시하는 최적의 방법으로 문제 해결을 못 하는 경우가 많다.
즉 처음에는, 내 손으로 한 땀 한 땀 구성해보고, 솔루션이 문제를 해결하는 방식에 충분한 공감이 되었을 때 그것을 사용해야 잘 활용할 수 있다.</p>

<p>이런 이유로 트레이스 환경도 직접 구성하기로 했다.</p>

<h2 id="behavior-log-남기기">Behavior log 남기기</h2>

<p>nginx에서 남기는 access log와 구분하기 위해 각 마이크로 서비스에서 남기는 트레이스 정보를 behavior log라고 부르기로 했다.
nginx에서 남기는 access log는 단순히 사용자의 접속 정보를 보여주는 것이라면, behavior log는 클라우드 내부의 마이크로 서비스들의 행위를 보여주는 로그인 것이다.</p>

<p>behavior log를 남기는 규칙과 방식은 다음과 같다.</p>

<h3 id="behavior-log-식별하기">behavior log 식별하기</h3>

<ul>
<li><code>RequestID</code></li>
<li><code>ActionID</code></li>
<li><code>ParentActionID</code></li>
</ul>

<p>사용자의 하나의 요청으로 이루어지는 모든 행위는 모두 같은 <code>RequestID</code>를 가진다.
그리고 각각의 마이크로 서비스에서 처리하는 행위는 고유의 <code>ActionID</code>를 가진다.
즉 마이크로 서비스에서 처리하는 모든 액션에는 <code>RequestID</code>와 <code>ActionID</code>가 부여된다.
이때 나를 호출한 caller 서비스의 <code>ActionID</code>는 <code>ParentActionID</code>가 된다.
<code>RequestID</code>, <code>ActionID</code>, <code>ParentActionID</code> 이 세 가지로 실제 요청이 처리되는 흐름을 정확하게 표현할 수 있다.</p>

<p>위 그림에서 표현한 Request 처리 흐름을 <code>RequestID</code>, <code>ActionID</code>, <code>ParentActionID</code> 세 가지로 다시 표현해 보았다.</p>

<p><img src="/images/tracing/tracing.png" alt="tracing" /></p>

<p>아래는 모든 마이크로 서비스가 지켜야 할 규칙이다.</p>

<ol>
<li>nginx에서 모든 요청에 대해 <code>RequestID</code>를 생성하고 헤더 <code>X-Request-ID</code>에 전달.<br />
(참고: <a href="http://nginx.org/en/docs/http/ngx_http_core_module.html#var_request_id">ngx_http_core_module.html#var_request_id</a>)</li>
<li>각 마이크로 서비스에서는 모든 요청 처리에 대해 <code>ActionID</code> 생성.</li>
<li>다른 마이크로 서비스를 호출할 때는 <code>RequestID</code>와 자신의 <code>ActionID</code>를 헤더 <code>X-Request-ID</code>, <code>X-Action-ID</code>에 전달.</li>
<li>각 마이크로 서비스에서 요청 처리가 끝나면 헤더를 통해 전달받은 <code>RequestID</code>와 자신이 직접 생성한 <code>ActionID</code>를 로그로 남김.
이때 Header에 <code>X-Action-ID</code>가 존재하면 그것을 <code>ParentActionID</code> 값으로 남긴다.</li>
</ol>

<p>위 기능을 처리하는 코드는 다음과 같다.
코드는 <a href="/post/go-my-way-1-webframework/">[#1 - 웹 프레임워크]</a>에서 설명한 echo 프레임워크를 기준으로 작성했다.</p>

<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">main</span>() {
	<span style="color:#a6e22e">e</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">echo</span>.<span style="color:#a6e22e">New</span>()
	<span style="color:#75715e">/* ... */</span>
	<span style="color:#a6e22e">e</span>.<span style="color:#a6e22e">Use</span>(<span style="color:#a6e22e">BehaviorMiddleware</span>)

	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">e</span>.<span style="color:#a6e22e">Start</span>(<span style="color:#e6db74">&#34;:8080&#34;</span>); <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
		<span style="color:#a6e22e">log</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#a6e22e">err</span>)
	}

}

<span style="color:#66d9ef">func</span> <span style="color:#a6e22e">BehaviorMiddleware</span>(<span style="color:#a6e22e">next</span> <span style="color:#a6e22e">echo</span>.<span style="color:#a6e22e">HandlerFunc</span>) <span style="color:#a6e22e">echo</span>.<span style="color:#a6e22e">HandlerFunc</span> {
	<span style="color:#66d9ef">return</span> <span style="color:#66d9ef">func</span>(<span style="color:#a6e22e">c</span> <span style="color:#a6e22e">echo</span>.<span style="color:#a6e22e">Context</span>) (<span style="color:#a6e22e">err</span> <span style="color:#66d9ef">error</span>) {
		<span style="color:#a6e22e">req</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">Request</span>()

		<span style="color:#a6e22e">requestId</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">req</span>.<span style="color:#a6e22e">Header</span>.<span style="color:#a6e22e">Get</span>(<span style="color:#e6db74">&#34;X-Request-ID&#34;</span>)
		<span style="color:#a6e22e">actionId</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">random</span>.<span style="color:#a6e22e">String</span>(<span style="color:#ae81ff">32</span>)
		<span style="color:#a6e22e">parentActionId</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">req</span>.<span style="color:#a6e22e">Header</span>.<span style="color:#a6e22e">Get</span>(<span style="color:#e6db74">&#34;X-Action-ID&#34;</span>)

		<span style="color:#66d9ef">defer</span> <span style="color:#66d9ef">func</span>(<span style="color:#a6e22e">begin</span> <span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">Time</span>) {
			<span style="color:#a6e22e">logrus</span>.<span style="color:#a6e22e">WithFields</span>(<span style="color:#a6e22e">logrus</span>.<span style="color:#a6e22e">Fields</span>{
				<span style="color:#e6db74">&#34;request_id&#34;</span>:       <span style="color:#a6e22e">requestId</span>,
				<span style="color:#e6db74">&#34;action_id&#34;</span>:        <span style="color:#a6e22e">actionId</span>,
				<span style="color:#e6db74">&#34;parent_action_id&#34;</span>: <span style="color:#a6e22e">parentActionId</span>,
				<span style="color:#e6db74">&#34;timestamp&#34;</span>:        <span style="color:#a6e22e">begin</span>.<span style="color:#a6e22e">UnixNano</span>(),
				<span style="color:#e6db74">&#34;latency&#34;</span>:          <span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">Since</span>(<span style="color:#a6e22e">begin</span>).<span style="color:#a6e22e">Nanoseconds</span>(),
				<span style="color:#e6db74">&#34;error&#34;</span>:            <span style="color:#a6e22e">err</span>,
				<span style="color:#75715e">/* ... */</span>
			}).<span style="color:#a6e22e">Info</span>()
		}(<span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">Now</span>())

		<span style="color:#75715e">/* ... */</span>

		<span style="color:#a6e22e">err</span> = <span style="color:#a6e22e">next</span>(<span style="color:#a6e22e">c</span>)

		<span style="color:#75715e">/* ... */</span>
		<span style="color:#66d9ef">return</span>
	}
}</code></pre></div>

<p>하지만 우리가 풀어야 할 과제는 이것뿐만이 아니다.
Request의 처리 완료 상황뿐만 아니라, 처리 과정 중에도 로그를 남겨야 하는 경우가 있다.
이 로그에도 <code>RequestID</code>, <code>ActionID</code>, <code>ParentActionID</code>가 있어야 전후의 맥락을 파악할 수 있다.
(<em>모든 로그는 전후의 상황을 함께 봐야 의미를 알 수 있다.</em>)
그리고 기본적인 Web Request 정보 외에도 로직 상의 중요한 값들은 함께 남겨 주어야 한다.(예: 현재 세션의 사용자 ID, 주요 파라미터, 처리 결과 요약 정보, 등)
즉, 단순히 미들웨어 기능만으로는 부족하다.</p>

<h3 id="logcontext"><code>LogContext</code></h3>

<p>Request가 처리되는 동안 <code>context.Context</code>에는 로그 내용을 담고 있는 <code>LogContext</code>가 보관되어 있다.
추가로 로그를 남기고 싶을 때 <code>context.Context</code>에 있는 <code>LogContext</code>를 사용해서 로그를 남긴다.
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#66d9ef">type</span> <span style="color:#a6e22e">LogContext</span> <span style="color:#66d9ef">struct</span> {
	<span style="color:#a6e22e">ParentActionID</span> <span style="color:#66d9ef">string</span>    <span style="color:#e6db74">`json:&#34;parent_action_id&#34;`</span>
	<span style="color:#a6e22e">ActionID</span>       <span style="color:#66d9ef">string</span>    <span style="color:#e6db74">`json:&#34;action_id&#34;`</span>
	<span style="color:#a6e22e">RequestID</span>      <span style="color:#66d9ef">string</span>    <span style="color:#e6db74">`json:&#34;request_id&#34;`</span>
	<span style="color:#a6e22e">Timestamp</span>      <span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">Time</span> <span style="color:#e6db74">`json:&#34;timestamp&#34;`</span>
	<span style="color:#a6e22e">Service</span>        <span style="color:#66d9ef">string</span>    <span style="color:#e6db74">`json:&#34;service&#34;`</span>

	<span style="color:#a6e22e">Params</span>     <span style="color:#66d9ef">interface</span>{}            <span style="color:#e6db74">`json:&#34;params,omitempty&#34;`</span>
	<span style="color:#a6e22e">Controller</span> <span style="color:#66d9ef">string</span>                 <span style="color:#e6db74">`json:&#34;controller,omitempty&#34;`</span>
	<span style="color:#a6e22e">Action</span>     <span style="color:#66d9ef">string</span>                 <span style="color:#e6db74">`json:&#34;action,omitempty&#34;`</span>
	<span style="color:#a6e22e">BizAttr</span>    <span style="color:#66d9ef">map</span>[<span style="color:#66d9ef">string</span>]<span style="color:#66d9ef">interface</span>{} <span style="color:#e6db74">`json:&#34;bizAttr,omitempty&#34;`</span>
	<span style="color:#a6e22e">Err</span>        <span style="color:#66d9ef">error</span>                  <span style="color:#e6db74">`json:&#34;error,omitempty&#34;`</span>

	<span style="color:#75715e">/* ... */</span>
}</code></pre></div></p>

<blockquote>
<p><small><code>LogContext</code>의 전체 소스코드는 <a href="https://github.com/pangpanglabs/goutils/blob/master/behaviorlog/behaviorlog.go">behaviorlog.go</a>를 참고해주세요</small></p>
</blockquote>

<p><code>context.Context</code>는 하나의 Request 처리가 완료될 때 까지 스콥(scope)이 유지되므로, 같은 요청을 처리하는 동안 <code>LogContext</code>를 통해 남기는 로그는 같은 <code>RequestID</code>, <code>ActionID</code>를 가진다.
즉, 모든 로그는 <code>RequestID</code>, <code>ActionID</code>를 가지게 되고, 모든 로그는 어떤 맥락에서 처리가 되었는지 확인이 가능하다.</p>

<p>로그를 남기는 코드는 아래와 같다.</p>

<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#a6e22e">BehaviorLogger</span>(<span style="color:#a6e22e">ctx</span>).
	<span style="color:#a6e22e">WithBizAttr</span>(<span style="color:#e6db74">&#34;userID&#34;</span>, <span style="color:#a6e22e">currentUser</span>.<span style="color:#a6e22e">ID</span>).
	<span style="color:#a6e22e">Log</span>(<span style="color:#e6db74">&#34;SearchDiscount&#34;</span>)</code></pre></div>

<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">BehaviorLogger</span>(<span style="color:#a6e22e">ctx</span> <span style="color:#a6e22e">context</span>.<span style="color:#a6e22e">Context</span>) <span style="color:#f92672">*</span><span style="color:#a6e22e">behaviorlog</span>.<span style="color:#a6e22e">LogContext</span> {
	<span style="color:#a6e22e">v</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">ctx</span>.<span style="color:#a6e22e">Value</span>(<span style="color:#a6e22e">behaviorlog</span>.<span style="color:#a6e22e">LogContextName</span>)
	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">logger</span>, <span style="color:#a6e22e">ok</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">v</span>.(<span style="color:#f92672">*</span><span style="color:#a6e22e">behaviorlog</span>.<span style="color:#a6e22e">LogContext</span>); <span style="color:#a6e22e">ok</span> {
		<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">logger</span>.<span style="color:#a6e22e">Clone</span>()
	}
	<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">behaviorlog</span>.<span style="color:#a6e22e">NewNopContext</span>()
}</code></pre></div>

<p>미들웨어에서는 <code>LogContext</code>를 사용하여 로그를 남기도록 아래와 같이 수정하였다.</p>

<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">BehaviorMiddleware</span>(<span style="color:#a6e22e">serviceName</span> <span style="color:#66d9ef">string</span>) <span style="color:#a6e22e">echo</span>.<span style="color:#a6e22e">MiddlewareFunc</span> {
	<span style="color:#66d9ef">return</span> <span style="color:#66d9ef">func</span>(<span style="color:#a6e22e">next</span> <span style="color:#a6e22e">echo</span>.<span style="color:#a6e22e">HandlerFunc</span>) <span style="color:#a6e22e">echo</span>.<span style="color:#a6e22e">HandlerFunc</span> {
		<span style="color:#66d9ef">return</span> <span style="color:#66d9ef">func</span>(<span style="color:#a6e22e">c</span> <span style="color:#a6e22e">echo</span>.<span style="color:#a6e22e">Context</span>) (<span style="color:#a6e22e">err</span> <span style="color:#66d9ef">error</span>) {
			<span style="color:#a6e22e">req</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">Request</span>()
			<span style="color:#a6e22e">behaviorLogger</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">behaviorlog</span>.<span style="color:#a6e22e">New</span>(<span style="color:#a6e22e">serviceName</span>, <span style="color:#a6e22e">req</span>)

			<span style="color:#75715e">// behaviorLogger를 context.Context에 담음
</span><span style="color:#75715e"></span>			<span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">SetRequest</span>(<span style="color:#a6e22e">req</span>.<span style="color:#a6e22e">WithContext</span>(
				<span style="color:#a6e22e">context</span>.<span style="color:#a6e22e">WithValue</span>(<span style="color:#a6e22e">req</span>.<span style="color:#a6e22e">Context</span>(),
					<span style="color:#a6e22e">behaviorlog</span>.<span style="color:#a6e22e">LogContextName</span>, <span style="color:#a6e22e">behaviorLogger</span>,
				)))

			<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> = <span style="color:#a6e22e">next</span>(<span style="color:#a6e22e">c</span>); <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
				<span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">Error</span>(<span style="color:#a6e22e">err</span>)
				<span style="color:#a6e22e">behaviorLogger</span>.<span style="color:#a6e22e">Err</span> = <span style="color:#a6e22e">err</span>
			}

			<span style="color:#75715e">/***
</span><span style="color:#75715e">			 처리 결과를 LogContext에 담는 로직
</span><span style="color:#75715e">			**/</span>

			<span style="color:#a6e22e">behaviorLogger</span>.<span style="color:#a6e22e">Write</span>()
			<span style="color:#66d9ef">return</span>
		}
	}
}</code></pre></div>

<p>Behavior log와 관련된 전체 소스코드는 아래 링크에서 확인할 수 있다.</p>

<ul>
<li><a href="https://github.com/pangpanglabs/goutils/blob/master/echomiddleware/behavior_logger.go">github.com/pangpanglabs/echomiddleware</a></li>
<li><a href="https://github.com/pangpanglabs/goutils/blob/master/behaviorlog/behaviorlog.go">github.com/pangpanglabs/behaviorlog</a></li>
</ul>

<h3 id="다른-서비스-호출하기">다른 서비스 호출하기</h3>

<p>앞서 다른 마이크로 서비스를 호출할때는 <code>RequestID</code>와 자신의 <code>ActionID</code>를 헤더에 담아서 전달한다고 설명했다.
어렵진 않지만 이것 또한 꽤나 번거로운 작업이다.
편의를 위해 <a href="https://github.com/pangpanglabs/goutils/tree/master/httpreq">github.com/pangpanglabs/goutils/httpreq</a> 패키지를 만들었다.
다른 마이크로 서비스를 호출할때는 <a href="https://github.com/pangpanglabs/goutils/tree/master/httpreq">httpreq</a> 패키지를 사용하면 편리하다.</p>

<p><div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#66d9ef">var</span> <span style="color:#a6e22e">v</span> <span style="color:#a6e22e">ApiResult</span>
<span style="color:#a6e22e">statusCode</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">httpreq</span>.<span style="color:#a6e22e">New</span>(<span style="color:#a6e22e">http</span>.<span style="color:#a6e22e">MethodPost</span>, <span style="color:#e6db74">&#34;TARGET_URL&#34;</span>, <span style="color:#a6e22e">param</span>).
	<span style="color:#a6e22e">WithRequestID</span>(<span style="color:#e6db74">&#34;requestID-1&#34;</span>).
	<span style="color:#a6e22e">WithActionID</span>(<span style="color:#e6db74">&#34;actionID-1&#34;</span>).
	<span style="color:#a6e22e">Call</span>(<span style="color:#f92672">&amp;</span><span style="color:#a6e22e">v</span>)</code></pre></div>
또는
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#66d9ef">var</span> <span style="color:#a6e22e">v</span> <span style="color:#a6e22e">ApiResult</span>
<span style="color:#a6e22e">statusCode</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">httpreq</span>.<span style="color:#a6e22e">New</span>(<span style="color:#a6e22e">http</span>.<span style="color:#a6e22e">MethodPost</span>, <span style="color:#e6db74">&#34;TARGET_URL&#34;</span>, <span style="color:#a6e22e">param</span>).
	<span style="color:#a6e22e">WithBehaviorLogContext</span>(<span style="color:#a6e22e">behaviorlog</span>.<span style="color:#a6e22e">FromCtx</span>(<span style="color:#a6e22e">ctx</span>)).
	<span style="color:#a6e22e">Call</span>(<span style="color:#f92672">&amp;</span><span style="color:#a6e22e">v</span>)</code></pre></div></p>

<h3 id="외부-api-호출하기">외부 API 호출하기</h3>

<p>호출하는 대상 서비스도 같은 방식으로 Behavior log를 남기도록 구성되어 있다면 트레이스 정보가 끊어지지 않고 하나의 흐름으로 이어질 것이다.
하지만 대상 서비스에서 Behavior log를 남기기 어려운 경우도 있다.
택배사 API를 사용한다던가 레거시 시스템과 인터페이스 하는 경우가 대표적인 예다.
이런 경우는 트레이스 로그의 흐름이 끊어지고 만다.</p>

<p>이렇게 우리의 관리 영역이 아닌 외부 API를 호출하는 경우는 외부 API의 처리 액션에 대한 Behavior log를 호출하는 쪽에서 남기기로 했다.</p>

<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#a6e22e">BehaviorLogger</span>(<span style="color:#a6e22e">ctx</span>).
	<span style="color:#a6e22e">WithBizAttr</span>(<span style="color:#e6db74">&#34;companyCode&#34;</span>, <span style="color:#e6db74">&#34;MY_COMPANY_CODE&#34;</span>).
	<span style="color:#a6e22e">WithCallURLInfo</span>(<span style="color:#a6e22e">http</span>.<span style="color:#a6e22e">MethodGet</span>, <span style="color:#e6db74">&#34;TARGET_URL&#34;</span>, <span style="color:#a6e22e">param</span>, <span style="color:#ae81ff">200</span>).
	<span style="color:#a6e22e">Log</span>(<span style="color:#e6db74">&#34;GetShippingStatus&#34;</span>)</code></pre></div>

<h2 id="안전한-로그-저장소">안전한 로그 저장소</h2>

<p>모든 트레이스 로그는 kafka를 거쳐 HDFS에 저장된다.
서로 다른 여러 데이터베이스에 쿼리를 실행할 수 있는 SQL Engine인 <a href="https://prestodb.io/">Presto</a>를 통해 필요한 데이터를 추출한다.</p>

<p><img src="/images/tracing/trace_hdfs.png" alt="trace-hdfs" /></p>

<p>트레이스 로그를 활용하여 다영한 시각화 도구를 만들 수 있다.
아래는 시각화 도구의 예로, 사용자의 요청이 어떤 과정을 통해 처리되고 있는지를 실시간으로 보여주고 있다.</p>

<div class="row post-image-bg">
    <video width="99%" height="540" autoplay loop muted>
        <source type="video/mp4" src="/images/tracing/eventflow.mp4"></source>
    </video>
</div>

		</div>
		
<div class="post__tags tags clearfix">
	<svg class="icon icon-tag" width="16" height="16" viewBox="0 0 16 16"><path d="M16 9.5c0 .373-.24.74-.5 1l-5 5c-.275.26-.634.5-1 .5-.373 0-.74-.24-1-.5L1 8a2.853 2.853 0 0 1-.7-1C.113 6.55 0 5.973 0 5.6V1.4C0 1.034.134.669.401.401.67.134 1.034 0 1.4 0h4.2c.373 0 .95.113 1.4.3.45.187.732.432 1 .7l7.5 7.502c.26.274.5.632.5.998zM3.5 5a1.5 1.5 0 1 0 0-3 1.5 1.5 0 0 0 0 3z"/></svg>
	<ul class="tags__list">
		<li class="tags__item"><a class="tags__link btn" href="/tags/golang/" rel="tag">golang</a></li>
	</ul>
</div>
	</article>
	
<div class="authorbox clearfix">
	<figure class="authorbox__avatar">
		<img alt="장재휴 avatar" src="/images/jaehue.JPG" class="avatar" height="90" width="90">
	</figure>
	<div class="authorbox__header">
		<span class="authorbox__name">About 장재휴</span>
	</div>
	<div class="authorbox__description">
		Why Not Change the World?
	</div>
</div>
	
<nav class="post-nav row clearfix">
	<div class="post-nav__item post-nav__item--prev col-1-2">
		<a class="post-nav__link" href="/post/go-my-way-2-database-and-logging/" rel="prev"><span class="post-nav__caption">«&thinsp;Previous</span><p class="post-nav__post-title">Go My Way #2 - 데이터베이스, 로깅</p></a>
	</div>
	<div class="post-nav__item post-nav__item--next col-1-2">
		<a class="post-nav__link" href="/post/event-driven/" rel="next"><span class="post-nav__caption">Next&thinsp;»</span><p class="post-nav__post-title">내 멋대로 구현한 이벤트 드리븐</p></a>
	</div>
</nav>
	
<section class="comments">
	<div id="disqus_thread"></div>
<script>
    var disqus_config = function () {
    
    
    
    };
    (function() {
        if (["localhost", "127.0.0.1"].indexOf(window.location.hostname) != -1) {
            document.getElementById('disqus_thread').innerHTML = 'Disqus comments not available by default when the website is previewed locally.';
            return;
        }
        var d = document, s = d.createElement('script'); s.async = true;
        s.src = '//' + "jaehue" + '.disqus.com/embed.js';
        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="https://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
</section>

</main>

<aside class="sidebar">
	
<div class="widget-search widget">
	<form class="widget-search__form" role="search" method="get" action="https://google.com/search">
		<label>
			<input class="widget-search__field" type="search" placeholder="SEARCH..." value="" name="q">
		</label>
		<input class="widget-search__submit" type="submit" value="Search">
		<input type="hidden" name="sitesearch" value="https://jaehue.github.io/" />
	</form>
</div>
	
<div class="widget-recent widget">
	<h4 class="widget__title">Recent Posts</h4>
	<div class="widget__content">
		<ul class="widget__list">
			<li class="widget__item"><a class="widget__link" href="/post/how-to-use-golang-context/">Golang에서 Context 사용하기</a></li>
			<li class="widget__item"><a class="widget__link" href="/post/camp_of_god/">하나님의 군대</a></li>
			<li class="widget__item"><a class="widget__link" href="/post/uganda-diary/">우간다에서의 생각들</a></li>
			<li class="widget__item"><a class="widget__link" href="/post/uganda-outreach/">🇺🇬 우간다 아웃리치</a></li>
			<li class="widget__item"><a class="widget__link" href="/post/event-driven/">내 멋대로 구현한 이벤트 드리븐</a></li>
		</ul>
	</div>
</div>
	
<div class="widget-categories widget">
	<h4 class="widget__title">Categories</h4>
	<div class="widget__content">
		<ul class="widget__list">
			<li class="widget__item"><a class="widget__link" href="/categories/it">It</a></li>
			<li class="widget__item"><a class="widget__link" href="/categories/%eb%ac%b5%ec%83%81">묵상</a></li>
			<li class="widget__item"><a class="widget__link" href="/categories/%ec%8b%a0%ec%95%99">신앙</a></li>
		</ul>
	</div>
</div>
	
	
<div class="widget-taglist widget">
	<h4 class="widget__title">Tags</h4>
	<div class="widget__content">
		<a class="widget-taglist__link widget__link btn" href="/tags/eventdriven" title="Eventdriven">Eventdriven (1)</a>
		<a class="widget-taglist__link widget__link btn" href="/tags/golang" title="Golang">Golang (6)</a>
		<a class="widget-taglist__link widget__link btn" href="/tags/microservice" title="Microservice">Microservice (1)</a>
		<a class="widget-taglist__link widget__link btn" href="/tags/%ec%8b%a0%eb%aa%85%ea%b8%b0" title="신명기">신명기 (1)</a>
		<a class="widget-taglist__link widget__link btn" href="/tags/%ec%97%ac%ed%96%89" title="여행">여행 (2)</a>
		<a class="widget-taglist__link widget__link btn" href="/tags/%ec%a4%91%ea%b5%adit" title="중국it">중국it (1)</a>
	</div>
</div>
</aside>
	</div>
		<footer class="footer">
			<div class="container container-inner">
				<div class="footer__copyright">&copy; 2018 Jaehue&#39;s. <span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span></div>
			</div>
		</footer>
	</div>

<script>
	var navigation = responsiveNav(".menu", {
		navClass: "menu--collapse",
	});
</script>
</body>
</html>